---
version: "3.8"
services:
  discovery-server:
    image: "urutare/service-discovery"
    build:
      context: "./stockm-discovery-service"
      dockerfile: "Dockerfile"
    restart: "always"
    ports:
    - "8761:8761"
    container_name: "discovery-server"
    networks:
    - "urutare-inc-network"
    healthcheck:
      test:
      - "CMD"
      - "curl"
      - "-f"
      - "http://localhost:8761/actuator/health"
      interval: "30s"
      timeout: "5s"
      retries: 3
  api-gateway:
    build:
      context: "./stockm-api-gateway"
      dockerfile: "Dockerfile"
    ports:
    - "8080:8080"
    restart: "on-failure"
    container_name: "api-gateway"
    environment:
      SERVER: "0.0.0.0"
      SERVER_PORT: 8080
      HOSTNAME: "api-gateway"
      EUREKA_SERVER_URL: "http://discovery-server:8761/eureka/"
    depends_on:
    - "discovery-server"
    - "stock-service"
    - "user-service"
    - "category-service"
    - "sync-service"
    - "payment-service"
    networks:
    - "urutare-inc-network"
    healthcheck:
      test:
      - "CMD"
      - "curl"
      - "-f"
      - "http://localhost:8080/actuator/health"
      interval: "30s"
      timeout: "10s"
      retries: 3
  postgres-db:
    image: "postgres"
    container_name: "postgres-db"
    restart: "always"
    ports:
    - "5435:5432"
    environment:
    - "POSTGRES_DB=kong"
    - "POSTGRES_USER=postgres"
    - "POSTGRES_PASSWORD=admin123!"
    command:
    - "postgres"
    - "-c"
    - "max_connections=200"
    - "-c"
    - "timezone=Etc/UTC"
    - "-c"
    - "default_text_search_config=pg_catalog.english"
    volumes:
    - "postgres-data:/var/lib/postgresql/data"
    - "./db-init:/docker-entrypoint-initdb.d"
    networks:
    - "urutare-inc-network"
  redis_cache:
    container_name: "redis"
    image: "bitnami/redis:latest"
    restart: "always"
    environment:
    - "ALLOW_EMPTY_PASSWORD=yes"
    ports:
    - "7379:6379"
    networks:
    - "urutare-inc-network"
  zookeeper-server:
    image: "bitnami/zookeeper:latest"
    container_name: "zookeeper-server"
    ports:
    - "2181:2181"
    environment:
    - "ALLOW_ANONYMOUS_LOGIN=yes"
    networks:
    - "kafka-network"
  kafka-broker:
    image: "bitnami/kafka:latest"
    container_name: "kafka-broker"
    ports:
    - "19092:9092"
    - "9093:9093"
    - "29092:29092"
    environment:
    - "KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper-server:2181"
    - "KAFKA_CFG_ADVERTISED_LISTENERS=INSIDE://kafka-broker:9092,OUTSIDE://localhost:29092"
    - "KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=INSIDE:PLAINTEXT,OUTSIDE:PLAINTEXT"
    - "KAFKA_CFG_LISTENERS=INSIDE://:9092,OUTSIDE://:29092"
    - "KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INSIDE"
    - "KAFKA_CFG_BROKER_ID=1"
    - "ALLOW_PLAINTEXT_LISTENER=yes"
    depends_on:
    - "zookeeper-server"
    networks:
    - "kafka-network"
  kafdrop:
    image: "obsidiandynamics/kafdrop"
    container_name: "kafdrop"
    ports:
    - "9000:9000"
    environment:
      KAFKA_BROKERCONNECT: "kafka-broker:9092"
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: "http://localhost:8761/eureka"
      JVM_OPTS: "-Xms32M -Xmx64M"
      SERVER_SERVLET_CONTEXTPATH: "/"
    depends_on:
    - "kafka-broker"
    networks:
    - "kafka-network"
    - "urutare-inc-network"
  user-service:
    image: "urutare/user-service"
    build:
      context: "./stockm-auth-service"
      dockerfile: "Dockerfile"
    restart: "on-failure"
    ports:
    - "8081:8081"
    container_name: "user-service"
    env_file:
    - "./secrets/.env"
    environment:
    - "SERVER_PORT=8081"
    - "DB_DATABASE=user_db"
    - "EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka"
    - "SPRING_APPLICATION_NAME=user-service"
    depends_on:
    - "discovery-server"
    - "postgres-db"
    - "kafka-broker"
    networks:
    - "urutare-inc-network"
    - "kafka-network"
  category-service:
    image: "urutare/category-service"
    build:
      context: "./stockm-category-service"
      dockerfile: "Dockerfile"
    ports:
    - "8082:8082"
    restart: "on-failure"
    container_name: "category-service"
    env_file:
    - "./secrets/.env"
    environment:
    - "SERVER_PORT=8082"
    - "EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka"
    - "SPRING_APPLICATION_NAME=category-service"
    - "EUREKA_INSTANCE_PREFER_IP_ADDRESS=true"
    - "SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-db:5432/category_db"
    - "SPRING_DATASOURCE_USERNAME=postgres"
    - "SPRING_DATASOURCE_PASSWORD=admin123!"
    - "SPRING_JPA_SHOW_SQL=true"
    - "SPRING_JPA_HIBERNATE_DDL_AUTO=update"
    - "LOGGING_LEVEL_ORG_HIBERNATE_SQL=debug"
    - "CLOUDINARY_CLOUD_NAME=http-voicetoworld-netlify-app"
    - "CLOUDINARY_API_KEY=958152517412848"
    - "CLOUDINARY_API_SECRET=h2eAzwp1zYxSKXe6lqHka-kopSQ"
    - "SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=10MB"
    - "SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=10MB"
    depends_on:
    - "discovery-server"
    - "postgres-db"
    networks:
    - "urutare-inc-network"
    - "kafka-network"
  stock-service:
    image: "urutare/stock-service"
    build:
      context: "./stockm-stock-service"
      dockerfile: "Dockerfile"
    restart: "on-failure"
    ports:
    - "8084:8084"
    container_name: "stock-service"
    env_file:
    - "./secrets/.env"
    environment:
    - "SERVER_PORT=8084"
    - "EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka"
    - "SPRING_APPLICATION_NAME=stock-service"
    - "SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-db:5432/stock_db"
    - "SPRING_DATASOURCE_USERNAME=postgres"
    - "SPRING_DATASOURCE_PASSWORD=admin123!"
    - "SPRING_JPA_SHOW_SQL=true"
    - "SPRING_JPA_HIBERNATE_DDL_AUTO=update"
    - "LOGGING_LEVEL_ORG_HIBERNATE_SQL=debug"
    - "SPRING_GRAPHQL_GRAPHIQL_ENABLED=true"
    - "SPRING_GRAPHQL_GRAPHIQL_PATH=/graphiql"
    depends_on:
    - "discovery-server"
    - "postgres-db"
    networks:
    - "urutare-inc-network"
    - "kafka-network"
  sync-service:
    image: "urutare/sync-service"
    build:
      context: "./stockm-sync-service"
      dockerfile: "Dockerfile"
    ports:
    - "8083:8080"
    - "5000:5000"
    restart: "on-failure"
    container_name: "sync-service"
    env_file:
    - "./secrets/.env"
    environment:
    - "SERVER_PORT=8080"
    - "EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka"
    - "SPRING_APPLICATION_NAME=sync-service"
    - "EUREKA_INSTANCE_PREFER_IP_ADDRESS=true"
    - "DB_DATABASE=sync_db"
    depends_on:
    - "discovery-server"
    - "postgres-db"
    - "kafka-broker"
    networks:
    - "urutare-inc-network"
    - "kafka-network"
  sms-gateway:
    restart: "on-failure"
    image: "urutare/sms-service"
    build:
      context: "./sms-gateway"
      dockerfile: "Dockerfile"
    container_name: "sms-gateway"
    env_file:
    - "./secrets/.env"
    - "./secrets/.env.sms"
    ports:
    - "8085:8000"
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: "512M"
    environment:
    - "LOCAL_PORT=8000"
    - "EUREKA_INSTANCE_PREFER_IP_ADDRESS=true"
    - "GATEWAY_BASE_URL=http://api-gateway:8080"
    - "DATABASE_URL=postgresql+asyncpg://postgres:admin123!@postgres-db:5432/sms_db"
    - "EUREKA_SERVER_URL=http://discovery-server:8761/eureka"
    - "EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://discovery-server:8761/eureka"
    - "SPRING_APPLICATION_NAME=sms-service"
    - "APP_NAME=sms-service"
    - "INSTANCE_HOST=localhost"
    depends_on:
    - "discovery-server"
    - "postgres-db"
    networks:
    - "urutare-inc-network"
    - "kafka-network"
  payment-service:
    image: "urutare/payment-service"
    build:
      context: "./stockm-payment-service"
      dockerfile: "Dockerfile"
    container_name: "payment-service"
    restart: "on-failure"
    ports:
    - "8086:8086"
    env_file:
    - "./secrets/.env"
    environment:
    - "SERVER_PORT=${SERVER_PORT:-8086}"
    - "SERVER=${SERVER:-localhost:8080}"
    - "EUREKA_SERVER_URL=${EUREKA_SERVER_URL:-http://discovery-server:8761/eureka}"
    - "ENVIRONMENT=${ENVIRONMENT:-local}"
    - "DB_HOSTNAME=${DB_HOSTNAME:-localhost}"
    - "DB_PORT=${DB_PORT:-5432}"
    - "DB_USER=${DB_USER:-postgres}"
    - "DB_PASS=${DB_PASS:-admin123!}"
    - "KAFKA_BROKER_URL=${KAFKA_BROKER_URL}"
    - "EMAIL_HOST=${EMAIL_HOST:-sandbox.smtp.mailtrap.io}"
    - "EMAIL_PORT=${EMAIL_PORT:-2525}"
    - "EMAIL_USERNAME=${EMAIL_USERNAME:-705d2be64f2ce5}"
    - "EMAIL_PASSWORD=${EMAIL_PASSWORD:-a8ab4c437a6cff}"
    - "MTN_MOMO_API=${MTN_MOMO_API}"
    - "MTN_API_USER=${MTN_API_USER}"
    - "MTN_API_KEY=${MTN_API_KEY}"
    - "MTN_PRIMARY_KEY=${MTN_PRIMARY_KEY}"
    - "MTN_SECONDARY_KEY=${MTN_SECONDARY_KEY}"
    - "MTN_TARGET_ENV=${MTN_TARGET_ENV}"
    - "MTN_CALLBACK_URL=${MTN_CALLBACK_URL}"
    depends_on:
    - "discovery-server"
    - "postgres-db"
    - "user-service"
    - "kafka-broker"
    networks:
    - "urutare-inc-network"
    - "kafka-network"
  portainer:
    image: "portainer/portainer-ce:latest"
    container_name: "portainer"
    restart: "always"
    ports:
    - "9001:9000"
    volumes:
    - "/var/run/docker.sock:/var/run/docker.sock"
    - "portainer_data:/data"
    depends_on:
    - "api-gateway"
    networks:
    - "urutare-inc-network"
networks:
  urutare-inc-network:
    driver: "bridge"
  kafka-network:
    driver: "bridge"
volumes:
  postgres-data: null
  kafka-data: null
  portainer_data: null
