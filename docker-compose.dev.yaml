version: "3.9"

x-common-environment: &common-environment
  JAVA_TOOL_OPTIONS: "-XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0"
  JAVA_OPTS: "-Xms128m -Xmx256m"
  SERVER_PORT: 8080

x-healthcheck-template: &healthcheck-template
  test: ["CMD", "wget", "--spider", "-q", "http://localhost:8080/actuator/health"]
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 15s

x-common-deploy: &common-deploy
  deploy:
    resources:
      limits:
        memory: 512M
        cpus: "0.25"

services:
  discovery-server-dev:
    image: stockm-discovery-service:latest
    container_name: stockm-discovery-service-dev
    ports:
      - "9761:8761"
    environment:
      <<: *common-environment
      EUREKA_HOSTNAME: discovery-server
      SERVER_PORT: 8761
    <<: *common-deploy
    networks:
      - urutare-stock-network-dev
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 15s
    extra_hosts:
      - "host.docker.internal:host-gateway"

  config-server-dev:
    image: stockm-config-service:latest
    container_name: stockm-config-service-dev
    ports:
      - "9888:8888"
    env_file:
      - ../environments/dev/secrets/envs/.env.config
    environment:
      <<: *common-environment
      SPRING_APPLICATION_NAME: config-server
      SERVER_PORT: 8888
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    networks:
      - urutare-stock-network-dev
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 15s

  api-gateway-dev:
    image: stockm-gateway-service:latest
    container_name: stockm-gateway-service-dev
    ports:
      - "9080:8080"
    env_file:
      - ../environments/dev/secrets/envs/.env.gateway
      - ../environments/dev/secrets/envs/.env.common
    environment:
      <<: *common-environment
      EUREKA_SERVER_URL: http://discovery-server:8761/eureka/
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 768M # Slightly higher for gateway
    volumes:
      - ../environments/dev/secrets/.env.properties:/app/.env.properties
      - ../environments/dev/secrets/.env.dev.jceks:/app/.env.jceks
    networks:
      - urutare-stock-network-dev
    healthcheck:
      <<: *healthcheck-template

  user-service-dev:
    image: stockm-user-service:latest
    container_name: stockm-user-service-dev
    ports:
      - "9081:8080"
    env_file:
      - ../environments/dev/secrets/envs/.env.user
      - ../environments/dev/secrets/envs/.env.common
    environment:
      <<: *common-environment
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    <<: *common-deploy
    healthcheck:
      <<: *healthcheck-template
    networks:
      - urutare-stock-network-dev
    volumes:
      - ./stockm-config-server/src/main/resources/config:/home/app/config
      - ../environments/dev/secrets/.env.properties:/app/.env.properties
      - ./../../env.dev.jceks:/app/.env.jceks

  category-service-dev:
    image: stockm-category-service:latest
    container_name: stockm-category-service-dev
    ports:
      - "9082:8080"
    env_file:
      - ../environments/dev/secrets/envs/.env.category
      - ../environments/dev/secrets/envs/.env.common
    environment:
      <<: *common-environment
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    <<: *common-deploy
    healthcheck:
      <<: *healthcheck-template
    networks:
      - urutare-stock-network-dev
    volumes:
      - ./stockm-config-server/src/main/resources/config:/home/app/config
      - ../environments/dev/secrets/.env.properties:/app/.env.properties
      - ./../../env.dev.jceks:/app/.env.jceks

  stock-service-dev:
    image: stockm-stock-service:latest
    container_name: stockm-stock-service-dev
    ports:
      - "9084:8080"
    env_file:
      - ../environments/dev/secrets/envs/.env.stock
      - ../environments/dev/secrets/envs/.env.common
    environment:
      <<: *common-environment
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    <<: *common-deploy
    healthcheck:
      <<: *healthcheck-template
    volumes:
      - ../environments/dev/secrets/.env.properties:/app/.env.properties
      - ./../../env.dev.jceks:/app/.env.jceks
    networks:
      - urutare-stock-network-dev

  sync-service-dev:
    image: stockm-sync-service:latest
    container_name: stockm-sync-service-dev
    ports:
      - "9083:8080"
      - "6000:5000"
    env_file:
      - ../environments/dev/secrets/envs/.env.sync
      - ../environments/dev/secrets/envs/.env.common
    environment:
      <<: *common-environment
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    <<: *common-deploy
    healthcheck:
      <<: *healthcheck-template
    volumes:
      - ./../../env.dev.jceks:/app/.env.jceks
      - ../environments/dev/secrets/.env.properties:/app/.env.properties
    networks:
      - urutare-stock-network-dev

  payment-service-dev:
    image: stockm-payment-service:latest
    container_name: stockm-payment-service-dev
    ports:
      - "9086:8080"
    env_file:
      - ../environments/dev/secrets/envs/.env.payment
      - ../environments/dev/secrets/envs/.env.common
    environment:
      <<: *common-environment
    depends_on:
      discovery-server-dev:
        condition: service_healthy
    <<: *common-deploy
    healthcheck:
      <<: *healthcheck-template
    volumes:
      - ./../../env.dev.jceks:/app/.env.jceks
      - ../environments/dev/secrets/.env.properties:/app/.env.properties
    networks:
      - urutare-stock-network-dev
      - urutare-db-network

networks:
  urutare-stock-network-dev:
    name: urutare-stock-network-dev
    driver: bridge

  urutare-db-network:
    external: true
