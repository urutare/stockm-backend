name: Java Spring Boot CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  MOTHER_REPO_URL: https://github.com/urutare/stockm-backend.git
  REMOTE_BASE_DIR: /root/stock
  DEV_DIR: /root/stock/dev
  PROD_DIR: /root/stock/production
  JAVA_VERSION: '21'
  MAVEN_OPTS: '-Xmx2048m -XX:MaxMetaspaceSize=512m'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Set Branch and Environment Variables
        id: vars
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          if [ "$BRANCH_NAME" = "main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "target_dir=${{ env.PROD_DIR }}" >> $GITHUB_OUTPUT
            echo "profile=prod" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" = "develop" ]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "target_dir=${{ env.DEV_DIR }}" >> $GITHUB_OUTPUT
            echo "profile=dev" >> $GITHUB_OUTPUT
          else
            echo "Unsupported branch: $BRANCH_NAME"
            exit 1
          fi

      - name: Create Remote Directory Structure
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # Run as root user
            sudo sh -c "
              # Create base directory structure
              mkdir -p ${{ steps.vars.outputs.target_dir }}
              
              # Set proper permissions
              chmod 755 ${{ steps.vars.outputs.target_dir }}
              
              echo \"Created and set permissions for directory: ${{ steps.vars.outputs.target_dir }}\"
            "

      - name: Clone Mother Repository on Remote Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # Run as root user
            sudo sh -c "
              cd ${{ steps.vars.outputs.target_dir }}
            
              # Remove existing mother repo if it exists
              if [ -d \"mother-repo\" ]; then
                echo \"Removing existing mother repository...\"
                rm -rf mother-repo
              fi
            
              # Clone the mother repository
              echo \"Cloning mother repository...\"
              git clone ${{ env.MOTHER_REPO_URL }} mother-repo
            
              cd mother-repo
            
              # Checkout the appropriate branch
              git checkout ${{ steps.vars.outputs.branch }}
            
              echo \"Successfully cloned mother repository on branch: ${{ steps.vars.outputs.branch }}\"
              ls -la
            "

      - name: Deploy Services and Modules
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            sudo sh -c '
              cd ${{ steps.vars.outputs.target_dir }}/mother-repo

              if [ ! -f "setup.sh" ]; then
                echo "Error: setup.sh not found in mother repository"
                exit 1
              fi

              chmod +x mvnw
              chmod +x setup.sh
              chmod +x build.sh

              echo "Injecting GitHub credentials..."
              export GH_USERNAME="${{ secrets.GH_USERNAME }}"
              export GH_PAT="${{ secrets.GH_PAT }}"

              # Rewrite setup.sh so it uses HTTPS with PAT
              sed -i "s#https://github.com/#https://$GH_USERNAME:$GH_PAT@github.com/#g" setup.sh

              echo "Clone by running setup.sh..."
              ./setup.sh

              echo "Build by running build.sh..."
              ./build.sh

              BRANCH_NAME="${{ steps.vars.outputs.branch }}"
              echo "Deploying branch: $BRANCH_NAME"
              
              if [ "$BRANCH_NAME" = "main" ]; then
                # Delete possibly existing container (but retain volumes)
                docker-compose -f docker-compose.prod.yaml down || true
                # Start docker-compose file
                docker-compose -f docker-compose.prod.yaml up -d
              elif [ "$BRANCH_NAME" = "develop" ]; then
                # Delete possibly existing container (but retain volumes)
                docker-compose -f docker-compose.dev.yaml down || true
                # Start docker-compose file
                docker-compose -f docker-compose.dev.yaml up -d
              else
                echo "Unsupported branch: $BRANCH_NAME"
                exit 1
              fi
            '

      - name: Send Deployment Notification
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.SERVER_USERNAME }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            # Run as root user
            sudo sh -c "
              echo \"===================================\"
              echo \"Deployment Summary\"
              echo \"===================================\"
              echo \"Branch: ${{ steps.vars.outputs.branch }}\"
              echo \"Environment: ${{ steps.vars.outputs.environment }}\"
              echo \"Target Directory: ${{ steps.vars.outputs.target_dir }}\"
              echo \"Profile: ${{ steps.vars.outputs.profile }}\"
              echo \"Timestamp: $(date)\"
              echo \"===================================\"
            "
  