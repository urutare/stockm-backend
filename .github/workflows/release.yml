---
name: "ğŸš€ Release & Deploy"
"on":
  release:
    types:
    - "published"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version"
        required: true
        default: "0.0.1-SNAPSHOT"
      deploy_env:
        description: "Deployment environment"
        required: true
        default: "staging"
        type: "choice"
        options:
        - "staging"
        - "production"
env:
  JAVA_VERSION: "21"
  MAVEN_OPTS: "-Xmx3072m -XX:+UseG1GC"
  REGISTRY: "ghcr.io"
  IMAGE_NAME: "${{ github.repository }}"
jobs:
  release:
    name: "ğŸš€ Build and Release"
    runs-on: "ubuntu-latest"
    permissions:
      contents: "read"
      packages: "write"
    outputs:
      version: "${{ steps.version.outputs.version }}"
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: "actions/checkout@v4"
      with:
        fetch-depth: 0
    - name: "â˜• Setup Java"
      uses: "actions/setup-java@v4"
      with:
        java-version: "${{ env.JAVA_VERSION }}"
        distribution: "temurin"
        cache: "maven"
    - name: "ğŸ”§ Setup Environment"
      run: "mkdir -p secrets\ncp .env.example secrets/.env\n./setup.sh\n"
      continue-on-error: true
    - name: "ğŸ“‹ Determine Version"
      id: "version"
      run: "if [ \"${{ github.event_name }}\" = \"release\" ]; then\n  VERSION=${{\
        \ github.event.release.tag_name }}\nelif [ \"${{ github.event_name }}\" =\
        \ \"workflow_dispatch\" ]; then\n  VERSION=${{ github.event.inputs.version\
        \ }}\nelse\n  VERSION=$(mvn help:evaluate -Dexpression=project.version -q\
        \ -DforceStdout)\nfi\necho \"version=${VERSION}\" >> $GITHUB_OUTPUT\necho\
        \ \"Building version: ${VERSION}\"\n"
    - name: "ğŸ—ï¸ Build and Test"
      run: "./mvnw clean verify -Pprod -B --no-transfer-progress \\\n  -Drevision=${{\
        \ steps.version.outputs.version }}\n"
    - name: "ğŸ“Š Upload Test Results"
      if: "always()"
      uses: "actions/upload-artifact@v4"
      with:
        name: "test-results"
        path: "target/surefire-reports/\ntarget/failsafe-reports/\ntarget/site/jacoco/\n"
    - name: "ğŸ” Login to Container Registry"
      uses: "docker/login-action@v3"
      with:
        registry: "${{ env.REGISTRY }}"
        username: "${{ github.actor }}"
        password: "${{ secrets.GITHUB_TOKEN }}"
    - name: "ğŸ³ Build and Push Docker Images"
      run: "# Build all service images\n./mvnw clean package -Pprod,docker -B --no-transfer-progress\
        \ \\\n  -Drevision=${{ steps.version.outputs.version }} \\\n  -DskipTests\n\
        \n# Tag and push images\nVERSION=${{ steps.version.outputs.version }}\n\n\
        # List of services to build images for\nSERVICES=(\n  \"stockm-discovery-service\"\
        \n  \"stockm-config-server\"\n  \"stockm-api-gateway\"\n  \"stockm-auth-service\"\
        \n  \"stockm-sync-service\"\n  \"stockm-stock-service\"\n  \"stockm-category-service\"\
        \n  \"stockm-payment-service\"\n  \"stockm-storage-service\"\n)\n\nfor service\
        \ in \"${SERVICES[@]}\"; do\n  if [ -d \"$service\" ]; then\n    echo \"Building\
        \ and pushing $service:$VERSION\"\n    docker build -t ${{ env.REGISTRY }}/${{\
        \ env.IMAGE_NAME }}/$service:$VERSION ./$service || echo \"Skipping $service\
        \ (no Dockerfile)\"\n    docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME\
        \ }}/$service:$VERSION ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$service:latest\n\
        \    docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$service:$VERSION\
        \ || echo \"Push failed for $service\"\n    docker push ${{ env.REGISTRY }}/${{\
        \ env.IMAGE_NAME }}/$service:latest || echo \"Push failed for $service:latest\"\
        \n  fi\ndone\n"
    - name: "ğŸ“¦ Create Release Artifacts"
      run: "mkdir -p release\n\n# Copy important files\ncp README.md release/\ncp\
        \ CODE_QUALITY.md release/\ncp VSCODE-SETUP.md release/\ncp docker-compose.prod.yaml\
        \ release/\ncp k8s.yaml release/\ncp -r .github release/\n\n# Create deployment\
        \ package\ntar -czf release/stockm-backend-${{ steps.version.outputs.version\
        \ }}.tar.gz \\\n  docker-compose.prod.yaml \\\n  k8s.yaml \\\n  Envs/ \\\n\
        \  secrets/ \\\n  README.md \\\n  .env.example\n"
    - name: "ğŸ“¤ Upload Release Artifacts"
      uses: "actions/upload-artifact@v4"
      with:
        name: "release-artifacts-${{ steps.version.outputs.version }}"
        path: "release/"
  deploy-staging:
    name: "ğŸš€ Deploy to Staging"
    needs: "release"
    if: "github.event.inputs.deploy_env == 'staging' || (github.event_name == 'release'\
      \ && !github.event.release.prerelease)"
    runs-on: "ubuntu-latest"
    environment: "staging"
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: "actions/checkout@v4"
    - name: "ğŸ”§ Setup Deployment"
      run: "echo \"Deploying version ${{ needs.release.outputs.version }} to staging\"\
        \n\n# Update docker-compose with new image tags\nsed -i \"s|:latest|:${{ needs.release.outputs.version\
        \ }}|g\" docker-compose.prod.yaml\n"
    - name: "ğŸš€ Deploy to Staging Environment"
      run: "echo \"ğŸš€ Deploying to staging environment...\"\necho \"Version: ${{ needs.release.outputs.version\
        \ }}\"\necho \"Environment: staging\"\n\n# Here you would typically:\n# 1.\
        \ SSH to staging server\n# 2. Pull latest images\n# 3. Update docker-compose.yaml\n\
        # 4. Restart services\n# 5. Run health checks\n\necho \"âœ… Deployment to staging\
        \ completed successfully\"\n"
  deploy-production:
    name: "ğŸ­ Deploy to Production"
    needs: "release"
    if: "github.event.inputs.deploy_env == 'production' || (github.event_name == 'release'\
      \ && !github.event.release.prerelease)"
    runs-on: "ubuntu-latest"
    environment: "production"
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: "actions/checkout@v4"
    - name: "ğŸ”§ Setup Production Deployment"
      run: "echo \"Deploying version ${{ needs.release.outputs.version }} to production\"\
        \n\n# Update kubernetes manifests with new image tags\nsed -i \"s|:latest|:${{\
        \ needs.release.outputs.version }}|g\" k8s.yaml\n"
    - name: "ğŸ­ Deploy to Production Environment"
      run: "echo \"ğŸ­ Deploying to production environment...\"\necho \"Version: ${{\
        \ needs.release.outputs.version }}\"\necho \"Environment: production\"\n\n\
        # Here you would typically:\n# 1. Connect to Kubernetes cluster\n# 2. Apply\
        \ updated manifests\n# 3. Monitor rollout status\n# 4. Run comprehensive health\
        \ checks\n# 5. Verify deployment\n\necho \"âœ… Deployment to production completed\
        \ successfully\"\n"
    - name: "ğŸ”” Notify Deployment Success"
      if: "success()"
      run: "echo \"ğŸ‰ Production deployment successful!\"\necho \"Version: ${{ needs.release.outputs.version\
        \ }}\"\n# Here you could send notifications to Slack, Teams, etc.\n"
  security-scan:
    name: "ğŸ›¡ï¸ Security Scan"
    needs: "release"
    runs-on: "ubuntu-latest"
    if: "always()"
    steps:
    - name: "ğŸ“¥ Checkout Code"
      uses: "actions/checkout@v4"
    - name: "ğŸ” Run Trivy Vulnerability Scanner"
      uses: "aquasecurity/trivy-action@master"
      with:
        scan-type: "fs"
        scan-ref: "."
        format: "sarif"
        output: "trivy-results.sarif"
    - name: "ğŸ“¤ Upload Trivy Scan Results"
      uses: "github/codeql-action/upload-sarif@v2"
      if: "always()"
      with:
        sarif_file: "trivy-results.sarif"
  notify:
    name: "ğŸ“¢ Notify Release"
    needs:
    - "release"
    - "deploy-staging"
    if: "always() && github.event_name == 'release'"
    runs-on: "ubuntu-latest"
    steps:
    - name: "ğŸ“¢ Announce Release"
      run: "echo \"ğŸ‰ Release ${{ needs.release.outputs.version }} completed!\"\n\
        echo \"Status: ${{ needs.deploy-staging.result }}\"\n\n# Here you could:\n\
        # - Send notifications to team channels\n# - Update project management tools\n\
        # - Create release notes\n# - Update documentation"
